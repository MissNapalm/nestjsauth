<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NestJS Auth - Portfolio Project</title>
  <style>
    :root {
      --bg-gradient-1: #667eea;
      --bg-gradient-2: #764ba2;
      --card-bg: white;
      --text-primary: #333;
      --text-secondary: #666;
      --text-muted: #999;
      --border-color: #ddd;
      --border-light: #eee;
      --input-bg: white;
      --profile-bg: #f8f9fa;
      --success-bg: #d4edda;
      --success-text: #155724;
      --success-border: #c3e6cb;
      --error-bg: #f8d7da;
      --error-text: #721c24;
      --error-border: #f5c6cb;
      --modal-overlay: rgba(0, 0, 0, 0.5);
      --shadow-color: rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] {
      --bg-gradient-1: #0a0a0f;
      --bg-gradient-2: #0d1b2a;
      --card-bg: #0f0f14;
      --text-primary: #e4e4e7;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #1e3a5f;
      --border-light: #1a1a24;
      --input-bg: #0a0a0f;
      --profile-bg: #0d1421;
      --success-bg: #0d2818;
      --success-text: #4ade80;
      --success-border: #166534;
      --error-bg: #2d0a0a;
      --error-text: #f87171;
      --error-border: #7f1d1d;
      --modal-overlay: rgba(0, 0, 0, 0.9);
      --shadow-color: rgba(0, 150, 255, 0.15);
      --accent-color: #38bdf8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
    }

    .container {
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 10px 30px var(--shadow-color);
      padding: 40px;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }

    h1 {
      color: var(--text-primary);
      margin-bottom: 10px;
      text-align: center;
      font-size: 28px;
    }

    .subtitle {
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid var(--border-light);
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.3s;
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    [data-theme="dark"] .tab-btn.active {
      color: #38bdf8;
      border-bottom-color: #38bdf8;
    }

    [data-theme="dark"] .tab-btn:hover:not(.active) {
      color: #0ea5e9;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-weight: 500;
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    [data-theme="dark"] input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    [data-theme="dark"] button {
      background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
    }

    [data-theme="dark"] button:hover {
      box-shadow: 0 5px 20px rgba(14, 165, 233, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .message {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .message.success {
      background: var(--success-bg);
      color: var(--success-text);
      border: 1px solid var(--success-border);
      display: block;
    }

    .message.error {
      background: var(--error-bg);
      color: var(--error-text);
      border: 1px solid var(--error-border);
      display: block;
    }

    .loading {
      display: none;
      text-align: center;
      color: #667eea;
      font-size: 14px;
    }

    .profile-info {
      background: var(--profile-bg);
      padding: 20px;
      border-radius: 6px;
      text-align: center;
      transition: background 0.3s ease;
    }

    .profile-info p {
      color: var(--text-secondary);
      margin-bottom: 10px;
      font-size: 14px;
    }

    .profile-info strong {
      color: var(--text-primary);
      display: block;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .logout-btn {
      margin-top: 20px;
      background: #dc3545;
    }

    .logout-btn:hover {
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
    }

    [data-theme="dark"] .logout-btn {
      background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%);
    }

    .forgot-password-link {
      display: inline-block;
      margin-top: 12px;
      color: #667eea;
      text-decoration: none;
      font-size: 13px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .forgot-password-link:hover {
      color: #764ba2;
      text-decoration: underline;
    }

    [data-theme="dark"] .forgot-password-link {
      color: #38bdf8;
    }

    [data-theme="dark"] .forgot-password-link:hover {
      color: #7dd3fc;
    }

    .reset-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--modal-overlay);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .reset-modal.active {
      display: flex;
    }

    .reset-modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 40px var(--shadow-color);
      position: relative;
      transition: background 0.3s ease;
    }

    .reset-modal-content h2 {
      color: var(--text-primary);
      margin-bottom: 20px;
      font-size: 22px;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      width: auto;
      padding: 0;
    }

    .close-modal:hover {
      color: var(--text-primary);
    }

    /* Theme Toggle */
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--card-bg);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      box-shadow: 0 2px 8px var(--shadow-color);
      transition: all 0.3s ease;
      opacity: 0.6;
      z-index: 999;
    }

    .theme-toggle:hover {
      opacity: 1;
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <!-- Discrete Theme Toggle -->
  <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
    <span id="themeIcon">üåô</span>
  </button>

  <div class="container">
    <div class="card">
      <h1>üîê Auth</h1>
      <p class="subtitle">Login & 2FA with Email</p>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('login', event)">Login</button>
        <button class="tab-btn" onclick="switchTab('register', event)">Register</button>
        <button class="tab-btn" onclick="switchTab('profile', event)">Profile</button>
      </div>

      <!-- Login Tab -->
      <div id="login" class="tab-content active">
        <div id="loginMessage" class="message"></div>
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmail" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" required>
          </div>
          <button type="submit">Send 2FA Code</button>
          <div class="loading" id="loginLoading">Sending...</div>
          <a class="forgot-password-link" onclick="openResetModal()">Forgot password?</a>
        </form>

        <div id="twoFactorForm" style="display: none; margin-top: 30px;">
          <h3 style="font-size: 16px; margin-bottom: 20px;">‚úâÔ∏è Check your email!</h3>
          <form onsubmit="handleVerify2FA(event)">
            <div class="form-group">
              <label>2FA Code</label>
              <input type="text" id="twoFactorCode" placeholder="000000" maxlength="6" required>
            </div>
            <button type="submit">Verify & Login</button>
            <div class="loading" id="verifyLoading">Verifying...</div>
          </form>
        </div>
      </div>

      <!-- Register Tab -->
      <div id="register" class="tab-content">
        <div id="registerMessage" class="message"></div>
        <form onsubmit="handleRegister(event)">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="registerEmail" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="registerPassword" required>
          </div>
          <button type="submit">Create Account</button>
          <div class="loading" id="registerLoading">Creating...</div>
        </form>
      </div>

      <!-- Profile Tab -->
      <div id="profile" class="tab-content">
        <div id="profileMessage" class="message"></div>
        <div id="profileContent" style="display: none;">
          <div class="profile-info">
            <p>User ID</p>
            <strong id="profileId"></strong>
            <p style="margin-top: 15px;">Email</p>
            <strong id="profileEmail"></strong>
          </div>
          <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
        <button onclick="loadProfile()" style="display: none;" id="loadProfileBtn">Load Profile</button>
      </div>
    </div>
  </div>

  <!-- Password Reset Modal -->
  <div id="resetModal" class="reset-modal">
    <div class="reset-modal-content">
      <button class="close-modal" onclick="closeResetModal()">√ó</button>
      <h2>Reset Password</h2>
      <div id="resetModalMessage" class="message"></div>
      
      <!-- Step 1: Request Reset -->
      <form id="requestResetForm" onsubmit="handleRequestReset(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="forgotEmail" required>
        </div>
        <button type="submit">Send Reset Link</button>
        <div class="loading" id="requestResetLoading">Sending...</div>
      </form>

      <!-- Step 2: Reset Password -->
      <form id="resetPasswordForm" style="display: none;" onsubmit="handleResetPassword(event)">
        <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 13px; color: #0066cc;">
          ‚úì Reset link sent! Check your email for the reset token.
        </div>
        <div class="form-group">
          <label>Reset Token</label>
          <input type="text" id="resetToken" placeholder="Paste token from email" required style="font-size: 12px;">
        </div>
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="newPassword" required>
        </div>
        <button type="submit">Reset Password</button>
        <div class="loading" id="resetPasswordLoading">Resetting...</div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/auth';
    let token = localStorage.getItem('token');

    function switchTab(tab, evt) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      // Show selected tab
      document.getElementById(tab).classList.add('active');
      
      // Only set active class on button if event was triggered by button click
      if (evt && evt.target) {
        evt.target.classList.add('active');
      }

      if (tab === 'profile' && token) {
        loadProfile();
      }
    }

    function showMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `message ${isError ? 'error' : 'success'}`;
    }

    async function handleRegister(e) {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const loading = document.getElementById('registerLoading');

      loading.style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('registerMessage', '‚úì Account created! You can now login.', false);
          document.getElementById('registerEmail').value = '';
          document.getElementById('registerPassword').value = '';
        } else {
          showMessage('registerMessage', data.message || 'Error registering', true);
        }
      } catch (error) {
        showMessage('registerMessage', 'Network error', true);
      } finally {
        loading.style.display = 'none';
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const loading = document.getElementById('loginLoading');

      loading.style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const data = await response.json();

        if (response.ok) {
          let message = '‚úì Code sent to your email!';
          if (data.testCode) {
            message = `‚úì Code sent! (Test code: <strong>${data.testCode}</strong> if email fails)`;
          }
          const msgEl = document.getElementById('loginMessage');
          msgEl.innerHTML = message;
          msgEl.className = 'message success';
          document.getElementById('twoFactorForm').style.display = 'block';
          document.getElementById('loginEmail').disabled = true;
          document.getElementById('loginPassword').disabled = true;
          localStorage.setItem('loginEmail', email);
        } else {
          showMessage('loginMessage', data.message || 'Login failed', true);
        }
      } catch (error) {
        showMessage('loginMessage', 'Network error', true);
      } finally {
        loading.style.display = 'none';
      }
    }

    async function handleVerify2FA(e) {
      e.preventDefault();
      const email = localStorage.getItem('loginEmail');
      const code = document.getElementById('twoFactorCode').value;
      const loading = document.getElementById('verifyLoading');

      loading.style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/verify-2fa`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code }),
        });

        const data = await response.json();

        if (response.ok) {
          token = data.access_token;
          localStorage.setItem('token', token);
          showMessage('loginMessage', '‚úì Logged in successfully!', false);
          
          // Reset form
          setTimeout(() => {
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('twoFactorCode').value = '';
            document.getElementById('twoFactorForm').style.display = 'none';
            document.getElementById('loginEmail').disabled = false;
            document.getElementById('loginPassword').disabled = false;
            switchTab('profile');
          }, 1500);
        } else {
          showMessage('loginMessage', data.message || 'Invalid code', true);
        }
      } catch (error) {
        showMessage('loginMessage', 'Network error', true);
      } finally {
        loading.style.display = 'none';
      }
    }

    async function loadProfile() {
      if (!token) {
        showMessage('profileMessage', 'Please login first', true);
        return;
      }

      console.log('Loading profile with token:', token ? token.substring(0, 20) + '...' : 'NO TOKEN');

      try {
        const response = await fetch(`${API_URL}/profile`, {
          headers: { 'Authorization': `Bearer ${token}` },
        });

        console.log('Profile response status:', response.status);

        if (response.ok) {
          const data = await response.json();
          document.getElementById('profileId').textContent = data.id;
          document.getElementById('profileEmail').textContent = data.email;
          document.getElementById('profileContent').style.display = 'block';
        } else {
          const errorData = await response.json();
          console.error('Profile error:', errorData);
          showMessage('profileMessage', 'Failed to load profile', true);
        }
      } catch (error) {
        console.error('Profile fetch error:', error);
        showMessage('profileMessage', 'Network error', true);
      }
    }

    function handleLogout() {
      token = null;
      localStorage.removeItem('token');
      localStorage.removeItem('loginEmail');
      document.getElementById('profileContent').style.display = 'none';
      document.getElementById('profileMessage').className = 'message';
      switchTab('login');
    }

    function openResetModal() {
      document.getElementById('resetModal').classList.add('active');
    }

    function closeResetModal() {
      document.getElementById('resetModal').classList.remove('active');
      // Reset form
      document.getElementById('forgotEmail').value = '';
      document.getElementById('resetToken').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('requestResetForm').style.display = 'block';
      document.getElementById('resetPasswordForm').style.display = 'none';
      document.getElementById('resetModalMessage').className = 'message';
    }

    async function handleRequestReset(e) {
      e.preventDefault();
      const email = document.getElementById('forgotEmail').value;
      const loading = document.getElementById('requestResetLoading');

      loading.style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/request-password-reset`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });

        const data = await response.json();

        if (response.ok) {
          const msgEl = document.getElementById('resetModalMessage');
          msgEl.textContent = '‚úì Reset link sent to your email!';
          msgEl.className = 'message success';
          document.getElementById('requestResetForm').style.display = 'none';
          document.getElementById('resetPasswordForm').style.display = 'block';
          document.getElementById('forgotEmail').disabled = true;
        } else {
          const msgEl = document.getElementById('resetModalMessage');
          msgEl.textContent = data.message || 'Error sending reset link';
          msgEl.className = 'message error';
        }
      } catch (error) {
        const msgEl = document.getElementById('resetModalMessage');
        msgEl.textContent = 'Network error';
        msgEl.className = 'message error';
      } finally {
        loading.style.display = 'none';
      }
    }

    async function handleResetPassword(e) {
      e.preventDefault();
      const token = document.getElementById('resetToken').value;
      const password = document.getElementById('newPassword').value;
      const loading = document.getElementById('resetPasswordLoading');

      loading.style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, password }),
        });

        const data = await response.json();

        if (response.ok) {
          const msgEl = document.getElementById('resetModalMessage');
          msgEl.textContent = '‚úì Password reset successful! Please login with your new password.';
          msgEl.className = 'message success';
          
          setTimeout(() => {
            closeResetModal();
          }, 2000);
        } else {
          const msgEl = document.getElementById('resetModalMessage');
          msgEl.textContent = data.message || 'Error resetting password';
          msgEl.className = 'message error';
        }
      } catch (error) {
        const msgEl = document.getElementById('resetModalMessage');
        msgEl.textContent = 'Network error';
        msgEl.className = 'message error';
      } finally {
        loading.style.display = 'none';
      }
    }

    // Auto-load profile if already logged in
    if (token && window.location.hash === '#profile') {
      loadProfile();
    }

    // Theme Toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('themeIcon');
      icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    // Load saved theme
    (function() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
      updateThemeIcon(savedTheme);
    })();
  </script>
</body>
</html>
